(()=>{"use strict";var e={945:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GenericPlayer=t.safe_execution=void 0;const a=o(i(361)),n=i(997),r=i(534),s=i(593);t.safe_execution=function(e,t,i){const o=i.value;return i.value=function(...e){if(this.isInitialized)return o.call(this,...e);throw new Error(`Cannot call method ${t} before player has initialized`)},i},t.GenericPlayer=class{tokenHandler;_positionHolder;eventEmitter=new a.default;playerInstance;_volume=0;device_id;_isInitialized=!1;get isInitialized(){return this._isInitialized}validateConfig(e){if(!e.auth)throw new Error("missing auth details from config");if(!e.auth.username||!e.auth.password)throw new Error("missing username or password from config");return e.auth.authType=e.auth.authType??"AUTHENTICATION_USER_PASS",e.backend=e.backend??"",e.bitrate=e.bitrate??"160",e.gapless=e.gapless??!1,e.passThrough=e.passThrough??!1,e.connectConfig={deviceType:e.connectConfig?.deviceType??"computer",hasVolumeControl:e.connectConfig?.hasVolumeControl??!0,initialVolume:e.connectConfig?.initialVolume??32768,name:e.connectConfig?.name??"librespot"},e.normalizationConfig={normalization:e.normalizationConfig?.normalization??!1,normalizationType:e.normalizationConfig?.normalizationType??"auto",normalizationMethod:e.normalizationConfig?.normalizationMethod??"basic",normalizationAttackCF:e.normalizationConfig?.normalizationAttackCF??0,normalizationKneeDB:e.normalizationConfig?.normalizationKneeDB??0,normalizationPregain:e.normalizationConfig?.normalizationPregain??0,normalizationReleaseCF:e.normalizationConfig?.normalizationReleaseCF??0,normalizationThreshold:e.normalizationConfig?.normalizationThreshold??0},e.cache={audio_location:e.cache?.audio_location,credentials_location:e.cache?.credentials_location,volume_location:e.cache?.audio_location,size_limiter:e.cache?.size_limiter},e.pos_update_interval=e.pos_update_interval??500,e}constructor(e,t="create_player"){let i=this.validateConfig(e);this.tokenHandler=new n.TokenHandler(i.cache?.credentials_location),this._positionHolder=new r.PositionHolder(e.pos_update_interval),s._librespotModule[t](i,this.player_event_callback.bind(this)).then((e=>{this.playerInstance=e,this.onPlayerInitialized(),this.registerListeners(),this._isInitialized=!0,this.eventEmitter.emit("PlayerInitialized",{event:"PlayerInitialized"})})).catch((e=>{this.eventEmitter.emit("InitializationError",{event:"InitializationError",error:e})})),this._positionHolder.callback=e=>{this.eventEmitter.emit("TimeUpdated",{event:"TimeUpdated",position_ms:e})}}player_event_callback(e){this.eventEmitter.emit(e.event,e)}registerListeners(){this.addListener("VolumeChanged",(e=>{this._volume=e.volume})),this.addListener("Playing",(e=>{this._positionHolder.setListener(),this._positionHolder.position=e.position_ms})),this.addListener("Paused",(e=>{this._positionHolder.clearListener(),this._positionHolder.position=e.position_ms})),this.addListener("Stopped",(e=>{this._positionHolder.clearListener(),this._positionHolder.position=0})),this.addListener("PositionCorrection",(e=>{this._positionHolder.position=e.position_ms})),this.addListener("Seeked",(e=>{this._positionHolder.position=e.position_ms})),this.addListener("TrackChanged",(()=>{this._positionHolder.clearListener(),this._positionHolder.position=0}))}on=this.addListener;off=this.removeListener;addListener(e,t){return this.eventEmitter.addListener(e,t)}removeListener(e,t){return this.eventEmitter.removeListener(e,t)}once(e,t){return this.eventEmitter.once(e,t)}removeAllListeners(){this.eventEmitter.removeAllListeners(),this.registerListeners()}getDeviceId(){return this.device_id}validateUri(e){const t=e.match(s.TRACK_REGEX);if(t?.groups?.type){if(t.groups.urlType?.startsWith("https")){const i=new URL(e);return[`spotify:${t.groups.type}:${i.pathname.split("/").at(-1)}`,t.groups.type]}return[e,t.groups.type]}return[void 0,void 0]}}},607:function(e,t,i){var o=this&&this.__createBinding||(Object.create?function(e,t,i,o){void 0===o&&(o=i);var a=Object.getOwnPropertyDescriptor(t,i);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,o,a)}:function(e,t,i,o){void 0===o&&(o=i),e[o]=t[i]}),a=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||o(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),a(i(696),t),a(i(251),t),a(i(699),t)},251:function(e,t,i){var o=this&&this.__decorate||function(e,t,i,o){var a,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var s=e.length-1;s>=0;s--)(a=e[s])&&(r=(n<3?a(r):n>3?a(t,i,r):a(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r};Object.defineProperty(t,"__esModule",{value:!0}),t.SpotifyPlayer=void 0;const a=i(593),n=i(945);class r extends n.GenericPlayer{onPlayerInitialized(){this.device_id=a._librespotModule.get_device_id.call(this.playerInstance)}async play(){await a._librespotModule.play.call(this.playerInstance)}async pause(){await a._librespotModule.pause.call(this.playerInstance)}async seek(e){await a._librespotModule.seek.call(this.playerInstance,e)}async close(){this._positionHolder.clearListener(),this.eventEmitter.removeAllListeners(),await a._librespotModule.close_player.call(this.playerInstance)}getCurrentPosition(){return this._positionHolder.position}async setVolume(e,t=!1){let i=e;t||(i=Math.max(Math.min(e,100),0)/100*65535),await a._librespotModule.set_volume.call(this.playerInstance,i)}getVolume(e=!1){return e?this._volume:this._volume/65535*100}async load(e,t=!1,i=0){const o=new RegExp(/^(?<urlType>(?:spotify:|(?:https?:\/\/(?:open|play)\.spotify\.com\/)))(?:embed)?\/?(?<type>album|track|playlist|artist)(?::|\/)((?:[0-9a-zA-Z]){22})/);"string"==typeof e&&(e=[e]);for(let t of e){const e=t.match(o);if(e?.groups?.type&&e.groups.urlType?.startsWith("https")){const i=new URL(t);t=`spotify:${e.groups.type}:${i.pathname.split("/").at(-1)}`}}for(const o of e)await a._librespotModule.load_track.call(this.playerInstance,o,t,i)}async getToken(...e){e=e&&e.length>0?e:a.DEFAULT_SCOPES;const t=await this.tokenHandler.getToken(e);if(t)return t;const i=await a._librespotModule.get_token.call(this.playerInstance,e.join(","));return i&&(i.scopes=i.scopes.split(","),i.expiry_from_epoch=Date.now()+i.expires_in,await this.tokenHandler.addToken(i)),i}async getCanvas(e){const[t,i]=this.validateUri(e);if(t&&"track"===i)return await a._librespotModule.get_canvas.call(this.playerInstance,t)}async getLyrics(e){const[t,i]=this.validateUri(e);if(t&&"track"===i){const e=await a._librespotModule.get_lyrics.call(this.playerInstance,t);try{return JSON.parse(e)}catch{return e}}}}o([n.safe_execution],r.prototype,"play",null),o([n.safe_execution],r.prototype,"pause",null),o([n.safe_execution],r.prototype,"seek",null),o([n.safe_execution],r.prototype,"close",null),o([n.safe_execution],r.prototype,"setVolume",null),o([n.safe_execution],r.prototype,"load",null),o([n.safe_execution],r.prototype,"getToken",null),o([n.safe_execution],r.prototype,"getCanvas",null),o([n.safe_execution],r.prototype,"getLyrics",null),t.SpotifyPlayer=r},534:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PositionHolder=void 0,t.PositionHolder=class{position=0;positionListener;updateInterval;callback;constructor(e){this.updateInterval=e||500}setListener(){this.clearListener(),this.positionListener=setInterval((()=>{this.position+=this.updateInterval,this.callback&&this.callback(this.position)}),this.updateInterval)}clearListener(){this.positionListener&&(clearInterval(this.positionListener),this.positionListener=void 0)}}},696:function(e,t,i){var o=this&&this.__decorate||function(e,t,i,o){var a,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var s=e.length-1;s>=0;s--)(a=e[s])&&(r=(n<3?a(r):n>3?a(t,i,r):a(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r};Object.defineProperty(t,"__esModule",{value:!0}),t.SpotifyPlayerSpirc=void 0;const a=i(593),n=i(945);class r extends n.GenericPlayer{onPlayerInitialized(){this.device_id=a._librespotModule.get_device_id_spirc.call(this.playerInstance)}constructor(e){super(e,"create_player_spirc")}async play(){await a._librespotModule.play_spirc.call(this.playerInstance)}async pause(){await a._librespotModule.pause_spirc.call(this.playerInstance)}async seek(e){await a._librespotModule.seek_spirc.call(this.playerInstance,e)}async close(){this._positionHolder.clearListener(),this.eventEmitter.removeAllListeners(),await a._librespotModule.close_player_spirc.call(this.playerInstance)}getCurrentPosition(){return this._positionHolder.position}async setVolume(e,t=!1){let i=e;t||(i=Math.max(Math.min(e,100),0)/100*65535),a._librespotModule.set_volume_spirc.call(this.playerInstance,i)}getVolume(e=!1){return e?this._volume:this._volume/65535*100}async load(e,t=!1){const[i,o]=this.validateUri(e);if(i&&"track"===o)return a._librespotModule.load_track_spirc.call(this.playerInstance,i,t)}async addToQueue(e){const t=(await this.getToken("user-modify-playback-state"))?.access_token;if(!t)throw Error("Failed to get a valid access token");console.debug("using existing token",t);const i={method:"POST",search:{device_id:this.device_id},auth:t},[o,n]=this.validateUri(e);if(!o||"track"!==n)throw new Error("URI must be of a track");i.search.uri=o,await(0,a.request)("https://api.spotify.com/v1/me/player/queue",i)}async getToken(...e){e=e&&e.length>0?e:a.DEFAULT_SCOPES;const t=await this.tokenHandler.getToken(e);if(t)return t;const i=await a._librespotModule.get_token_spirc.call(this.playerInstance,e.join(","));return i&&(i.scopes=i.scopes.split(","),i.expiry_from_epoch=Date.now()+i.expires_in,await this.tokenHandler.addToken(i)),i}async getCanvas(e){const[t,i]=this.validateUri(e);if(t&&"track"===i)return await a._librespotModule.get_canvas_spirc.call(this.playerInstance,t)}async getLyrics(e){const[t,i]=this.validateUri(e);if(t&&"track"===i){const e=await a._librespotModule.get_lyrics_spirc.call(this.playerInstance,t);try{return JSON.parse(e)}catch{return e}}}}o([n.safe_execution],r.prototype,"play",null),o([n.safe_execution],r.prototype,"pause",null),o([n.safe_execution],r.prototype,"seek",null),o([n.safe_execution],r.prototype,"close",null),o([n.safe_execution],r.prototype,"setVolume",null),o([n.safe_execution],r.prototype,"load",null),o([n.safe_execution],r.prototype,"addToQueue",null),o([n.safe_execution],r.prototype,"getToken",null),o([n.safe_execution],r.prototype,"getCanvas",null),o([n.safe_execution],r.prototype,"getLyrics",null),t.SpotifyPlayerSpirc=r},997:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TokenHandler=void 0;const a=o(i(491)),n=i(292),r=o(i(17));t.TokenHandler=class{tokenMap=[];filePath;readFilePromise;constructor(e){e&&(this.filePath=r.default.join(e,"tokens.json")),this.readFilePromise=this.readFile()}async dumpFile(){this.filePath&&await(0,n.writeFile)(this.filePath,JSON.stringify(this.tokenMap))}async readFile(){if(this.filePath)try{this.tokenMap=JSON.parse(await(0,n.readFile)(this.filePath,{encoding:"utf-8"})),(0,a.default)(Array.isArray(this.tokenMap))}catch(e){console.warn("Failed to parse token store, creating new"),this.tokenMap=[]}}async addToken(e){await this.readFilePromise,this.tokenMap.push(e),await this.dumpFile()}async getToken(e){await this.readFilePromise;for(const t of this.tokenMap)if(e.some((e=>t.scopes.includes(e)))&&t.expiry_from_epoch>Date.now())return t}}},699:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},593:function(e,t,i){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t._librespotModule=t.DEFAULT_SCOPES=t.request=t.TRACK_REGEX=void 0;const a=o(i(687));t.TRACK_REGEX=new RegExp(/^(?<urlType>(?:spotify:|(?:https?:\/\/(?:open|play)\.spotify\.com\/)))(?:embed)?\/?(?<type>album|track|playlist|artist)(?::|\/)((?:[0-9a-zA-Z]){22})/),t.request=function(e,t){return new Promise(((i,o)=>{const n=new URL(e);if(t.headers||(t.headers={}),t.headers["Content-Type"]||(t.headers["Content-Type"]="application/json"),t.body){const e=t.body instanceof Uint8Array?t.body:JSON.stringify(t.body);t.headers["Content-Length"]=Buffer.byteLength(e)}t.auth&&(t.headers.Authorization=`Bearer ${t.auth}`);const r={host:n.hostname,path:`${n.pathname}${t.search?`?${new URLSearchParams(t.search).toString()}`:""}`,protocol:"https:",method:t.method,headers:t.headers};let s="",l=a.default.request(r,(e=>{e.on("data",(e=>{s+=e})),e.on("end",(()=>{if(e.statusCode&&e.statusCode>=200&&e.statusCode<=299)try{i(JSON.parse(s))}catch{i(s)}else o(s)}))}));if(l.on("error",o),t.body){const e=t.body instanceof Uint8Array?t.body:JSON.stringify(t.body);l.write(e)}l.end()}))},t.DEFAULT_SCOPES=["playlist-read-collaborative","user-follow-read","user-library-read","user-top-read","user-read-recently-played","user-modify-playback-state"],t._librespotModule=i(421)},421:e=>{e.exports=require("./build/librespot.node")},491:e=>{e.exports=require("assert")},361:e=>{e.exports=require("events")},292:e=>{e.exports=require("fs/promises")},687:e=>{e.exports=require("https")},17:e=>{e.exports=require("path")}},t={},i=function i(o){var a=t[o];if(void 0!==a)return a.exports;var n=t[o]={exports:{}};return e[o].call(n.exports,n,n.exports,i),n.exports}(607);module.exports=i})();