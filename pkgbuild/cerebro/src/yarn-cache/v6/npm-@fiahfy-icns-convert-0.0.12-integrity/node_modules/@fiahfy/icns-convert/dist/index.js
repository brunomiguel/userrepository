"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.convert = void 0;
const sharp_1 = __importDefault(require("sharp"));
const icns_1 = require("@fiahfy/icns");
const convertFromBuffer = async (buffer) => {
    const image = sharp_1.default(buffer);
    const { width, height } = await image.metadata();
    if (!width || !height || width !== height) {
        throw new TypeError('Image should be squre');
    }
    if (width < 1024 || height < 1024) {
        console.warn('Warning: Image should be 1024x1024 pixels or more');
    }
    const icns = new icns_1.Icns();
    for (const { osType, size } of icns_1.Icns.supportedIconTypes) {
        const cloned = image.clone().resize(size, size);
        const buf = await cloned.png().toBuffer();
        icns.append(icns_1.IcnsImage.fromPNG(buf, osType));
    }
    return icns.data;
};
const convertFromBuffers = async (buffers) => {
    const icns = new icns_1.Icns();
    const sizes = [];
    for (const buffer of buffers) {
        const image = sharp_1.default(buffer);
        const { width, height } = await image.metadata();
        if (!width || !height || width !== height) {
            throw new TypeError('Image should be squre');
        }
        const size = width;
        const types = icns_1.Icns.supportedIconTypes.filter((type) => type.size === size);
        if (!types) {
            throw new TypeError(`Warning: No supported pixels (${size}x${size})`);
        }
        sizes.push(size);
        const buf = await image.png().toBuffer();
        for (const { osType } of types) {
            icns.append(icns_1.IcnsImage.fromPNG(buf, osType));
        }
    }
    if (!sizes.length) {
        throw new TypeError('No valid images');
    }
    const missingSizes = icns_1.Icns.supportedIconTypes
        .map((type) => type.size)
        .filter((size) => !sizes.includes(size));
    if (missingSizes.length) {
        const pixels = missingSizes.map((size) => `${size}x${size}`).join(', ');
        console.warn(`Warning: Missing pixels (${pixels})`);
    }
    return icns.data;
};
const convert = async (buffer) => {
    if (Buffer.isBuffer(buffer)) {
        return convertFromBuffer(buffer);
    }
    else if (Array.isArray(buffer)) {
        return convertFromBuffers(buffer);
    }
    else {
        throw new TypeError('Image must be Buffer or Buffer Array');
    }
};
exports.convert = convert;
