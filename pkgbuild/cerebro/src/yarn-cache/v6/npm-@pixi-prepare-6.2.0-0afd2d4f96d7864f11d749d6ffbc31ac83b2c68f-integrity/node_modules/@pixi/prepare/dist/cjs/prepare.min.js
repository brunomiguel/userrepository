/*!
 * @pixi/prepare - v6.2.0
 * Compiled Mon, 01 Nov 2021 16:52:10 UTC
 *
 * @pixi/prepare is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var settings=require("@pixi/settings"),core=require("@pixi/core"),graphics=require("@pixi/graphics"),ticker=require("@pixi/ticker"),display=require("@pixi/display"),text=require("@pixi/text");settings.settings.UPLOADS_PER_FRAME=4;var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function __extends(e,t){function i(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var CountLimiter=function(){function e(e){this.maxItemsPerFrame=e,this.itemsLeft=0}return e.prototype.beginFrame=function(){this.itemsLeft=this.maxItemsPerFrame},e.prototype.allowedToUpload=function(){return this.itemsLeft-- >0},e}();function findMultipleBaseTextures(e,t){var i=!1;if(e&&e._textures&&e._textures.length)for(var r=0;r<e._textures.length;r++)if(e._textures[r]instanceof core.Texture){var s=e._textures[r].baseTexture;-1===t.indexOf(s)&&(t.push(s),i=!0)}return i}function findBaseTexture(e,t){if(e.baseTexture instanceof core.BaseTexture){var i=e.baseTexture;return-1===t.indexOf(i)&&t.push(i),!0}return!1}function findTexture(e,t){if(e._texture&&e._texture instanceof core.Texture){var i=e._texture.baseTexture;return-1===t.indexOf(i)&&t.push(i),!0}return!1}function drawText(e,t){return t instanceof text.Text&&(t.updateText(!0),!0)}function calculateTextStyle(e,t){if(t instanceof text.TextStyle){var i=t.toFontString();return text.TextMetrics.measureFont(i),!0}return!1}function findText(e,t){if(e instanceof text.Text){-1===t.indexOf(e.style)&&t.push(e.style),-1===t.indexOf(e)&&t.push(e);var i=e._texture.baseTexture;return-1===t.indexOf(i)&&t.push(i),!0}return!1}function findTextStyle(e,t){return e instanceof text.TextStyle&&(-1===t.indexOf(e)&&t.push(e),!0)}var BasePrepare=function(){function e(e){var t=this;this.limiter=new CountLimiter(settings.settings.UPLOADS_PER_FRAME),this.renderer=e,this.uploadHookHelper=null,this.queue=[],this.addHooks=[],this.uploadHooks=[],this.completes=[],this.ticking=!1,this.delayedTick=function(){t.queue&&t.prepareItems()},this.registerFindHook(findText),this.registerFindHook(findTextStyle),this.registerFindHook(findMultipleBaseTextures),this.registerFindHook(findBaseTexture),this.registerFindHook(findTexture),this.registerUploadHook(drawText),this.registerUploadHook(calculateTextStyle)}return e.prototype.upload=function(e,t){"function"==typeof e&&(t=e,e=null),e&&this.add(e),this.queue.length?(t&&this.completes.push(t),this.ticking||(this.ticking=!0,ticker.Ticker.system.addOnce(this.tick,this,ticker.UPDATE_PRIORITY.UTILITY))):t&&t()},e.prototype.tick=function(){setTimeout(this.delayedTick,0)},e.prototype.prepareItems=function(){for(this.limiter.beginFrame();this.queue.length&&this.limiter.allowedToUpload();){var e=this.queue[0],t=!1;if(e&&!e._destroyed)for(var i=0,r=this.uploadHooks.length;i<r;i++)if(this.uploadHooks[i](this.uploadHookHelper,e)){this.queue.shift(),t=!0;break}t||this.queue.shift()}if(this.queue.length)ticker.Ticker.system.addOnce(this.tick,this,ticker.UPDATE_PRIORITY.UTILITY);else{this.ticking=!1;var s=this.completes.slice(0);this.completes.length=0;for(i=0,r=s.length;i<r;i++)s[i]()}},e.prototype.registerFindHook=function(e){return e&&this.addHooks.push(e),this},e.prototype.registerUploadHook=function(e){return e&&this.uploadHooks.push(e),this},e.prototype.add=function(e){for(var t=0,i=this.addHooks.length;t<i&&!this.addHooks[t](e,this.queue);t++);if(e instanceof display.Container)for(t=e.children.length-1;t>=0;t--)this.add(e.children[t]);return this},e.prototype.destroy=function(){this.ticking&&ticker.Ticker.system.remove(this.tick,this),this.ticking=!1,this.addHooks=null,this.uploadHooks=null,this.renderer=null,this.completes=null,this.queue=null,this.limiter=null,this.uploadHookHelper=null},e}();function uploadBaseTextures(e,t){return t instanceof core.BaseTexture&&(t._glTextures[e.CONTEXT_UID]||e.texture.bind(t),!0)}function uploadGraphics(e,t){if(!(t instanceof graphics.Graphics))return!1;var i=t.geometry;t.finishPoly(),i.updateBatches();for(var r=i.batches,s=0;s<r.length;s++){var n=r[s].style.texture;n&&uploadBaseTextures(e,n.baseTexture)}return i.batchable||e.geometry.bind(i,t._resolveDirectShader(e)),!0}function findGraphics(e,t){return e instanceof graphics.Graphics&&(t.push(e),!0)}var Prepare=function(e){function t(t){var i=e.call(this,t)||this;return i.uploadHookHelper=i.renderer,i.registerFindHook(findGraphics),i.registerUploadHook(uploadBaseTextures),i.registerUploadHook(uploadGraphics),i}return __extends(t,e),t}(BasePrepare),TimeLimiter=function(){function e(e){this.maxMilliseconds=e,this.frameStart=0}return e.prototype.beginFrame=function(){this.frameStart=Date.now()},e.prototype.allowedToUpload=function(){return Date.now()-this.frameStart<this.maxMilliseconds},e}();exports.BasePrepare=BasePrepare,exports.CountLimiter=CountLimiter,exports.Prepare=Prepare,exports.TimeLimiter=TimeLimiter;
//# sourceMappingURL=prepare.min.js.map
